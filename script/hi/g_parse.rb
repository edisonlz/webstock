require File.dirname(__FILE__) + '/../config/environment.rb'
#puts "Starting Stock Maintance......"
require 'rubygems'
require 'hpricot'
require 'open-uri'
#require 'htmlentities'
#gem install hpricot --source #http://code.whytheluckystiff.net
#gem install hpricot
#sudo apt-get install ruby1.8-dev linux-libc-dev libc6-dev
#sudo apt-get install build-essential
#1.sudo aptitude install ruby1.8-dev
#2.sudo gem install mechanize
#icnv = Iconv.new("GBK", "UTF-8")
#icnv.iconv(src)
while true do
  #1 day excute 2 times
  sleep 60*60*12
  #puts "start loading google financial info!"
  f=nil
  sd=nil
  doc=nil
  temp=""
  begin
    #sd=StockDetail.find(:all,:conditions=>["current_price>0"])
  rescue
    puts "An error occurred: ",$!
    return
  end
  sd=['000001','000002','000003','000004','000005','000006','000007','000008','000009','000010','000011','000012','000013','000014','000015','000016','000017','000018','000019','000020','000021','000022','000023','000024','000025','000026','000027','000028','000029','000030','000031','000032','000033','000034','000035','000036','000037','000039','000040','000042','000043','000045','000046','000048','000049','000050','000055','000056','000058','000059','000060','000061','000062','000063','000065','000066','000068','000069','000070','000078','000088','000089','000090','000096','000099','000100','000150','000151','000153','000155','000157','000158','000159','000300','000301','000338','000400','000401','000402','000404','000407','000408','000409','000410','000411','000413','000415','000416','000417','000418','000419','000420','000421','000422','000423','000425','000426','000428','000429','000430','000488','000498','000501','000502','000503','000504','000505','000507','000509','000510','000511','000513','000514','000515','000516','000518','000519','000520','000521','000522','000523','000524','000525','000526','000527','000528','000530','000531','000532','000533','000534','000536','000537','000538','000539','000540','000541','000543','000544','000545','000546','000547','000548','000550','000551','000552','000553','000554','000555','000557','000558','000559','000560','000561','000562','000563','000564','000565','000566','000567','000568','000569','000570','000571','000572','000573','000576','000578','000581','000582','000584','000585','000586','000587','000589','000590','000591','000592','000593','000594','000595','000596','000597','000598','000599','000600','000601','000602','000603','000605','000606','000607','000608','000609','000610','000611','000612','000613','000615','000616','000617','000619','000623','000625','000626','000627','000628','000629','000630','000632','000633','000635','000636','000637','000639','000650','000651','000652','000655','000656','000657','000659','000661','000662','000663','000665','000666','000667','000668','000669','000671','000673','000676','000677','000678','000679','000680','000681','000682','000683','000685','000686','000687','000690','000691','000692','000695','000697','000698','000700','000701','000702','000703','000705','000707','000708','000709','000710','000711','000712','000713','000715','000716','000717','000718','000719','000720','000721','000722','000723','000725','000726','000727','000728','000729','000731','000733','000735','000736','000737','000738','000739','000748','000750','000751','000752','000753','000755','000756','000758','000759','000760','000761','000762','000766','000767','000768','000776','000777','000778','000779','000780','000782','000783','000785','000786','000788','000789','000790','000791','000792','000793','000795','000796','000797','000798','000799','000800','000801','000802','000803','000806','000807','000809','000810','000811','000812','000813','000815','000816','000818','000819','000820','000821','000822','000823','000825','000826','000828','000829','000830','000831','000833','000835','000836','000837','000838','000839','000848','000850','000851','000852','000856','000858','000859','000860','000861','000862','000868','000869','000875','000876','000877','000878','000880','000881','000882','000883','000885','000886','000887','000888','000889','000890','000892','000893','000895','000897','000898','000899','000900','000901','000902','000903','000905','000906','000908','000909','000910','000911','000912','000913','000914','000915','000916','000917','000918','000919','000920','000921','000922','000923','000925','000926','000927','000928','000929','000930','000931','000932','000933','000935','000936','000937','000938','000939','000948','000949','000950','000951','000952','000953','000955','000957','000958','000959','000960','000961','000962','000963','000965','000966','000967','000968','000969','000970','000971','000972','000973','000975','000976','000977','000978','000979','000980','000981','000982','000983','000985','000987','000988','000989','000990','000993','000995','000996','000997','000998','000999','001696','001896','002001','002002','002003','002004','002005','002006','002007','002008','002009','002010','002011','002012','002013','002014','002015','002016','002017','002018','002019','002020','002021','002022','002023','002024','002025','002026','002027','002028','002029','002030','002031','002032','002033','002034','002035','002036','002037','002038','002039','002040','002041','002042','002043','002044','002045','002046','002047','002048','002049','002050','002051','002052','002053','002054','002055','002056','002057','002058','002059','002060','002061','002062','002063','002064','002065','002066','002067','002068','002069','002070','002071','002072','002073','002074','002075','002076','002077','002078','002079','002080','002081','002082','002083','002084','002085','002086','002087','002088','002089','002090','002091','002092','002093','002094','002095','002096','002097','002098','002099','002100','002101','002102','002103','002104','002105','002106','002107','002108','002109','002110','002111','002112','002113','002114','002115','002116','002117','002118','002119','002120','002121','002122','002123','002124','002125','002126','002127','002128','002129','002130','002131','002132','002133','002134','002135','002136','002137','002138','002139','002140','002141','002142','002143','002144','002145','002146','002147','002148','002149','002150','002151','002152','002153','002154','002155','002156','002157','002158','002159','002160','002161','002162','002163','002164','002165','002166','002167','002168','002169','002170','002171','002172','002173','002174','002175','002176','002177','002178','002179','002180','002181','002182','002183','002184','002185','002186','002187','002188','002189','002190','002191','002192','002193','002194','002195','002196','002197','002198','002199','002200','002201','002202','002203','002204','002205','002206','002207','002208','002209','002210','002211','002212','002213','002214','002215','002216','002217','002218','002219','002220','002221','002222','002223','002224','002225','002226','002227','002228','002229','002230','002231','002232','002233','002234','002235','002236','002237','002238','002239','002240','002241','002242','002243','002244','002245','002246','002247','002248','002249','002250','002251','002252','002253','002254','002255','002256','002258','002259','002260','002261','002262','002263','002264','002265','002266','002267','002268','002269','030002','031002','031006','031007','038003','038004','159901','159902','160101','160102','160103','160105','160106','160108','160109','160110','160201','160202','160203','160204','160205','160206','160207','160208','160301','160302','160303','160304','160305','160306','160307','160308','160309','160310','160311','160401','160402','160403','160404','160405','160406','160407','160501','160502','160503','160504','160505','160506','160507','160508','160601','160602','160603','160605','160607','160608','160610','160701','160702','160703','160704','160705','160706','160707','160708','160709','160710','160801','160802','160803','160804','160805','160901','160902','160903','160904','160905','160906','160907','160908','160909','161005','161101','161102','161103','161105','161106','161107','161201','161202','161203','161205','161301','161302','161303','161501','161502','161503','161607','161701','161702','161703','161704','161706','161707','161708','161801','161802','161803','161804','161806','161807','161901','161902','161903','162001','162002','162003','162004','162005','162006','162101','162102','162201','162202','162203','162204','162205','162206','162207','162208','162301','162302','162304','162305','162306','162401','162402','162403','162404','162405','162406','162408','162409','162501','162502','162503','162504','162505','162601','162602','162603','162604','162605','162607','162608','162609','162701','162702','162703','162705','162706','162801','162802','162803','162804','162901','162902','162903','162904','163101','163102','163103','163104','163105','163201','163203','163205','163301','163302','163401','163402','163403','163501','163502','163503','163601','163602','163603','163604','163701','163702','163703','163704','163801','163803','163804','163901','163902','163903','164001','164003','164101','164103','164201','164501','164502','164503','164601','164602','164603','164801','164803','164804','165301','165303','165304','165401','165402','165501','165502','165801','165802','166001','184688','184689','184690','184691','184692','184693','184695','184696','184698','184699','184700','184701','184703','184705','184706','184709','184710','184712','184713','184718','184719','184721','184722','184728','184738','1A0001','1T0001','200002','200003','200011','200012','200016','200017','200018','200019','200020','200022','200024','200025','200026','200028','200029','200030','200037','200039','200041','200045','200053','200054','200055','200056','200058','200152','200160','200168','200413','200418','200429','200468','200488','200505','200512','200513','200521','200530','200539','200541','200550','200553','200570','200581','200596','200613','200625','200706','200725','200726','200761','200770','200771','200869','200986','200992','399001','399002','399003','399004','399100','399101','399106','399107','399108','399110','399120','399130','399131','399132','399133','399134','399135','399136','399137','399138','399139','399140','399150','399160','399170','399180','399190','399200','399210','399220','399230','399300','399305','399310','399311','399312','399313','399314','399315','399316','399317','399318','399319','399320','399321','399322','399323','399324','399325','399326','399327','399328','399329','399330','399331','399332','399351','399352','399353','399481','399901','399902','399903','500001','500002','500003','500005','500006','500007','500008','500009','500010','500011','500015','500018','500025','500029','500035','500038','500039','500056','500058','510050','510051','510052','510180','510181','510182','510880','510881','510882','519001','519003','519005','519007','519008','519011','519013','519017','519018','519021','519028','519029','519087','519100','519180','519181','519300','519508','519518','519519','519666','519688','519690','519692','519993','519995','519997','522001','522003','522005','522007','522008','522011','522013','522017','522018','522028','522029','522087','522100','522180','522181','522300','522508','522518','522519','522666','522688','522690','522692','522993','522995','522997','523001','523003','523005','523007','523008','523011','523013','523017','523018','523028','523029','523087','523100','523180','523181','523300','523519','523666','523688','523690','523692','523993','523995','523997','580010','580012','580013','580014','580015','580016','580017','580018','580019','580020','580021','580022','580023','580024','580025','580989','600000','600001','600003','600004','600005','600006','600007','600008','600009','600010','600011','600012','600015','600016','600017','600018','600019','600020','600021','600022','600026','600027','600028','600029','600030','600031','600033','600035','600036','600037','600038','600039','600048','600050','600051','600052','600053','600054','600055','600056','600057','600058','600059','600060','600061','600062','600063','600064','600066','600067','600068','600069','600070','600071','600072','600073','600074','600075','600076','600077','600078','600079','600080','600081','600082','600083','600084','600085','600086','600087','600088','600089','600090','600091','600093','600094','600095','600096','600097','600098','600099','600100','600101','600102','600103','600104','600105','600106','600107','600108','600109','600110','600111','600112','600113','600114','600115','600116','600117','600118','600119','600120','600121','600122','600123','600125','600126','600127','600128','600129','600130','600131','600132','600133','600135','600136','600137','600138','600139','600141','600143','600145','600146','600148','600149','600150','600151','600152','600153','600155','600156','600157','600158','600159','600160','600161','600162','600163','600165','600166','600167','600168','600169','600170','600171','600172','600173','600175','600176','600177','600178','600179','600180','600182','600183','600184','600185','600186','600188','600189','600190','600191','600192','600193','600195','600196','600197','600198','600199','600200','600201','600202','600203','600205','600206','600207','600208','600209','600210','600211','600212','600213','600215','600216','600217','600218','600219','600220','600221','600222','600223','600226','600227','600228','600229','600230','600231','600232','600233','600234','600235','600236','600237','600238','600239','600240','600241','600243','600246','600247','600249','600250','600251','600252','600253','600255','600256','600257','600258','600260','600261','600262','600263','600265','600266','600267','600268','600269','600270','600271','600272','600273','600275','600276','600277','600278','600279','600280','600281','600282','600283','600284','600285','600287','600288','600289','600290','600291','600292','600293','600295','600297','600298','600299','600300','600301','600302','600303','600305','600306','600307','600308','600309','600310','600311','600312','600313','600315','600316','600317','600318','600319','600320','600321','600322','600323','600325','600326','600327','600328','600329','600330','600331','600332','600333','600335','600336','600337','600338','600339','600340','600343','600345','600346','600348','600350','600351','600352','600353','600354','600355','600356','600357','600358','600359','600360','600361','600362','600363','600365','600366','600367','600368','600369','600370','600371','600372','600373','600375','600376','600377','600378','600379','600380','600381','600382','600383','600385','600386','600387','600388','600389','600390','600391','600392','600393','600395','600396','600397','600398','600399','600400','600401','600403','600405','600406','600408','600409','600410','600415','600416','600418','600419','600420','600421','600422','600423','600425','600426','600428','600429','600432','600433','600435','600436','600438','600439','600444','600446','600448','600449','600452','600455','600456','600458','600459','600460','600461','600462','600463','600466','600467','600468','600469','600470','600472','600475','600476','600477','600478','600479','600480','600481','600482','600483','600485','600486','600487','600488','600489','600490','600491','600493','600495','600496','600497','600498','600499','600500','600501','600502','600503','600505','600506','600507','600508','600509','600510','600511','600512','600513','600515','600516','600517','600518','600519','600520','600521','600522','600523','600525','600526','600527','600528','600529','600530','600531','600532','600533','600535','600536','600537','600538','600539','600540','600543','600545','600546','600547','600548','600549','600550','600551','600552','600553','600555','600556','600557','600558','600559','600560','600561','600562','600563','600565','600566','600567','600568','600569','600570','600571','600572','600573','600575','600576','600577','600578','600579','600580','600581','600582','600583','600584','600585','600586','600587','600588','600589','600590','600591','600592','600593','600594','600595','600596','600597','600598','600599','600600','600601','600602','600603','600604','600605','600606','600607','600608','600609','600610','600611','600612','600613','600614','600615','600616','600617','600618','600619','600620','600621','600622','600623','600624','600626','600627','600628','600629','600630','600631','600633','600634','600635','600636','600637','600638','600639','600640','600641','600642','600643','600644','600645','600647','600648','600649','600650','600651','600652','600653','600654','600655','600656','600657','600658','600660','600661','600662','600663','600664','600665','600666','600667','600668','600671','600673','600674','600675','600676','600677','600678','600679','600680','600681','600682','600683','600684','600685','600686','600687','600688','600689','600690','600691','600692','600693','600694','600695','600696','600697','600698','600699','600701','600702','600703','600704','600706','600707','600708','600710','600711','600712','600713','600714','600715','600716','600717','600718','600719','600720','600721','600722','600723','600724','600725','600726','600727','600728','600729','600730','600731','600732','600733','600735','600736','600737','600738','600739','600740','600741','600742','600743','600744','600745','600746','600747','600748','600749','600750','600751','600753','600754','600755','600756','600757','600758','600759','600760','600761','600763','600764','600765','600766','600767','600768','600769','600770','600771','600773','600774','600775','600776','600777','600778','600779','600780','600781','600782','600783','600784','600785','600786','600787','600789','600790','600791','600792','600793','600794','600795','600796','600797','600798','600800','600801','600802','600803','600804','600805','600806','600807','600808','600809','600810','600811','600812','600814','600815','600816','600817','600818','600819','600820','600821','600822','600823','600824','600825','600826','600827','600828','600829','600830','600831','600832','600833','600834','600835','600836','600837','600838','600839','600840','600841','600842','600843','600844','600845','600846','600847','600848','600849','600850','600851','600852','600853','600854','600855','600856','600857','600858','600859','600860','600861','600862','600863','600864','600865','600866','600867','600868','600869','600870','600871','600872','600873','600874','600875','600876','600877','600879','600880','600881','600882','600883','600884','600885','600886','600887','600888','600889','600890','600891','600892','600893','600894','600895','600896','600897','600898','600900','600960','600961','600962','600963','600965','600966','600967','600969','600970','600971','600973','600975','600976','600978','600979','600980','600981','600982','600983','600984','600985','600986','600987','600988','600990','600991','600992','600993','600995','600997','601001','601002','601003','601005','601006','601007','601008','601009','601088','601099','601111','601166','601168','601169','601186','601318','601328','601333','601390','601398','601588','601600','601601','601628','601666','601699','601766','601808','601857','601866','601872','601898','601899','601918','601919','601939','601958','601988','601991','601998','601999','900901','900902','900903','900904','900905','900906','900907','900908','900909','900910','900911','900912','900913','900914','900915','900916','900917','900918','900919','900920','900921','900922','900923','900924','900925','900926','900927','900928','900929','900930','900932','900933','900934','900935','900936','900937','900938','900939','900940','900941','900942','900943','900945','900946','900947','900948','900949','900950','900951','900952','900953','900955','900956','900957']
  #sd=[600000,600006]
  unless sd.blank?
    #coder = HTMLEntities.new
    #读取一只股票，显示一只股票
    for s in sd
      #s=s.code.to_s
      begin
        doc = open("http://finance.google.cn/finance?client=ob&q=SHA:"+s.to_s) { |ft| Hpricot(ft) }
      rescue
        next
      end
      #begin
      path=File.dirname(__FILE__) + "/../tmp/stock_data_info/"
      FileUtils.mkdir_p(path) unless File.directory?(path)
      f= File.open(path+s.to_s+".txt", File::WRONLY|File::TRUNC|File::CREAT)
      f.flock(File::LOCK_EX)
     
      #f.puts (doc/"#keyratios").to_html
      #puts 
      #f.puts "#events"
      f.puts "<g_lz>"
      temp=(doc/"#events").to_html
      event_doc = Hpricot(temp)
      temp=""
      (event_doc/"tr/td").each do |td|
        #puts td.inner_text
        temp+=td.inner_text.strip+"/"
      end
      # f.puts coder.encode(temp.strip)
      f.puts temp.to_s.strip
      #
      f.puts "<g_lz>" 
      temp=(doc/"#summary").to_html
      summary_doc = Hpricot(temp)
      temp=""
      (summary_doc/"div").each do |div|
        if div.attributes['class']=="item companySummary"
          temp=div.inner_text.strip
        end
      end
      #f.puts coder.encode(temp.to_s.strip)
      f.puts temp.to_s.strip
      #f.puts "#summary"
      f.puts "<g_lz>"
      temp=(doc/"#management").to_html
      management_doc = Hpricot(temp)
      temp=""
      (management_doc/"tr/td").each do |td|
        #puts td.inner_text
        temp+=td.inner_text.strip+"/"
      end
      #f.puts coder.encode(temp.strip)
      f.puts temp.to_s.strip
      #f.puts "#management"
      f.puts "<g_lz>"
      #temp=(doc/"#newstabsgroup_initial").to_html
      #f.puts coder.encode(temp.strip)
      #f.puts "#newstabsgroup_initial"
      f.puts "<g_lz>"
      temp=(doc/"#related").to_html 
      related_doc = Hpricot(temp)
      temp=""
      (related_doc/"tr/td").each do |td|
        #puts td.inner_text
        #puts td.inner_text
        temp+=td.inner_text+"/"
      end
      #f.puts coder.encode(temp.strip)
      f.puts temp.to_s.strip
      #f.puts "#keyratios"
      f.puts "<g_lz>"
      temp=(doc/"#keyratios").to_html
      keyratios_doc = Hpricot(temp)
      temp=""
      (keyratios_doc/"tr/td").each do |td|
        #puts td.inner_text
        #puts td.inner_text
        temp+=td.inner_text.strip+"/"
      end
      #f.puts coder.encode(temp.strip)
      f.puts temp.to_s.strip
      
      #      begin
      #        docs = open("#http://q.stock.sohu.com/cn/"+s.to_s+"/index.shtml") { |nt| Hpricot(nt) }
      #      rescue
      #        unless f.blank?
      #          f.flock(File::LOCK_UN)
      #          unless f.closed?
      #            f.close
      #          end
      #        end
      #        next
      #      end
      #      f.puts "<g_lz>"
      #      temp=(docs/"#BIZ_IS_info").to_html
      #      bs_doc = Hpricot(temp)
      #      temp=""
      #      (bs_doc/"div/ul/li").each do |li|
      #        temp+=li.inner_text.strip+""
      #      end
      #      f.puts coder.encode(temp.strip)
    
      puts s.to_s
      unless f.blank?
        f.flock(File::LOCK_UN)
        unless f.closed?
          f.close
        end
      end
    end #end for
  end #end sd.blank

end